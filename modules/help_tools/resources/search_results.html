<!--
//=============================================================================
// Copyright (c) 2016-present Allan CORNET (Nelson)
//=============================================================================
// This file is part of Nelson.
//=============================================================================
// LICENCE_BLOCK_BEGIN
// SPDX-License-Identifier: LGPL-3.0-or-later
// LICENCE_BLOCK_END
//=============================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Search Results</title>
  <link rel="stylesheet" href="nelson_common.css">
</head>
<body class="search-results-body">
  <!-- Help Summary Button at top right -->
  <a href="./homepage.html" class="home-summary-link">
    <button class="home-summary-btn" aria-label="Back to help homepage">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12L12 3l9 9"/>
        <path d="M9 21V12h6v9"/>
        <path d="M9 21h6"/>
      </svg>
    </button>
  </a>
  
  <h1 class="search-results-title"></h1>
  <div id="results" class="search-results-panel">
  </div>
  <script src="index.js"></script>
  
  <!-- localized behavior: detect lang, apply messages, append lang to links -->
  <script>
    function escapeHTML(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, function (m) {
        switch (m) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#39;';
          default: return m;
        }
      });
    }
    
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    
    // normalize variants to en_US / fr_FR
    function normalizeLang(raw) {
      if (!raw) return null;
      const v = raw.toString().toLowerCase();
      // handle tokens and full path fragments like "en", "en_us", "en-us", "/help/en_US/"
      if (v.indexOf('fr') === 0 || v.indexOf('fr_') !== -1 || v.indexOf('fr-') !== -1 || v.indexOf('/fr') !== -1) return 'fr_FR';
      if (v.indexOf('en') === 0 || v.indexOf('en_') !== -1 || v.indexOf('en-') !== -1 || v.indexOf('/en') !== -1) return 'en_US';
      return null;
    }

    const messages = {
      en_US: {
        title: 'Search Results',
        loading: 'Loading search index...',
        index_empty: 'Warning: Search index is empty or could not be loaded.',
        no_query: 'No search term provided.',
        found_results: (n, q) => `Found ${n} results for <strong>${escapeHTML(q)}</strong>:`,
        no_results_for: q => `No results found for <strong>${escapeHTML(q)}</strong>.`,
        popular_topics: 'Popular topics:',
        home_aria: 'Back to help homepage'
      },
      fr_FR: {
        title: 'Résultats de recherche',
        loading: "Chargement de l'index de recherche...",
        index_empty: "Attention : l'index de recherche est vide ou n'a pas pu être chargé.",
        no_query: "Aucun terme de recherche fourni.",
        found_results: (n, q) => `Trouvé ${n} résultat(s) pour <strong>${escapeHTML(q)}</strong> :`,
        no_results_for: q => `Aucun résultat pour <strong>${escapeHTML(q)}</strong>.`,
        popular_topics: 'Sujets populaires :',
        home_aria: "Retour à la page d'accueil de l'aide"
      }
    };

    // read initial lang from URL or localStorage, fallback to en_US
    function readInitialLanguage() {
      // 1) check explicit lang query param
      const params = new URLSearchParams(window.location.search);
      const p = params.get('lang');
      const fromParam = normalizeLang(p);
      if (fromParam) {
        localStorage.setItem('nelson_lang', fromParam);
        return fromParam;
      }

      // 2) check pathname for en_US / fr_FR segments (works for file:/// paths)
      try {
        const path = (window.location.pathname || '').toLowerCase();
        const pathMatch = path.match(/(?:\/|\\)(fr(?:[_-]fr)?|en(?:[_-]us)?)(?:\/|\\|$)/i);
        if (pathMatch && pathMatch[1]) {
          const normalizedPath = normalizeLang(pathMatch[1]);
          if (normalizedPath) {
            localStorage.setItem('nelson_lang', normalizedPath);
            return normalizedPath;
          }
        }
      } catch (e) {
        // ignore
      }

      // 3) localStorage or navigator.language fallback
      const stored = localStorage.getItem('nelson_lang') || navigator.language || 'en';
      const normalized = normalizeLang(stored) || 'en_US';
      localStorage.setItem('nelson_lang', normalized);
      return normalized;
    }

    const lang = readInitialLanguage();
    const msg = messages[lang] || messages.en_US;

    // set document lang attribute for accessibility / correct rendering
    document.documentElement.lang = (lang === 'fr_FR') ? 'fr-FR' : 'en-US';
    // set page title and aria on home button
    document.title = msg.title;
    const homeButton = document.querySelector('.home-summary-link > .home-summary-btn');
    if (homeButton) {
      homeButton.setAttribute('aria-label', msg.home_aria);
    }

    // set the visible H1 to localized title
    const pageTitle = document.querySelector('.search-results-title');
    if (pageTitle) pageTitle.textContent = msg.title;
    
    // ensure URL we build includes lang param
    function appendLangToUrl(urlStr) {
      try {
        const u = new URL(urlStr, window.location);
        u.searchParams.set('lang', lang);
        return u.toString();
      } catch (e) {
        // fallback for relative paths
        return urlStr + (urlStr.includes('?') ? '&' : '?') + 'lang=' + encodeURIComponent(lang);
      }
    }

    // update home link to include lang
    const homeLink = document.querySelector('.home-summary-link');
    if (homeLink) {
      homeLink.setAttribute('href', appendLangToUrl('./homepage.html'));
    }

    let helpIndex = window.searchIndex || [];
    
    function search(query) {
      if (!query) return [];

      query = query.toLowerCase();

      let results = helpIndex.filter(item => {
        return item.title.toLowerCase().includes(query) ||
               item.content.toLowerCase().includes(query);
      }).map(item => {
        let snippet = item.content;
        const contentLower = item.content.toLowerCase();
        const queryIndex = contentLower.indexOf(query);

        if (queryIndex !== -1) {
          const start = Math.max(0, queryIndex - 40);
          const end = Math.min(item.content.length, queryIndex + query.length + 40);
          snippet = (start > 0 ? '...' : '') +
                    item.content.substring(start, end) +
                    (end < item.content.length ? '...' : '');
          const highlightedSnippet = snippet.replace(
            new RegExp(query, 'gi'),
            match => `<strong>${match}</strong>`
          );
          snippet = highlightedSnippet;
        } else {
          snippet = item.content.substring(0, 100) + (item.content.length > 100 ? '...' : '');
        }

        return {
          title: item.title,
          url: item.url,
          path: item.path,
          snippet: snippet
        };
      });

      // Move exact match to the front if present
      const exactIndex = results.findIndex(r => r.title.toLowerCase() === query);
      if (exactIndex > -1) {
        const [exactResult] = results.splice(exactIndex, 1);
        results.unshift(exactResult);
      }

      return results;
    }
    
    function loadHelpIndex() {
      return new Promise((resolve, reject) => {
        if (window.searchIndex && window.searchIndex.length > 0) {
          helpIndex = window.searchIndex;
          return resolve(helpIndex);
        }
        // if not present, resolve with empty array (existing behavior)
        resolve([]);
      });
    }
    
    async function processSearch() {
      const query = getQueryParam('query');
      const resultsDiv = document.getElementById('results');
      
      resultsDiv.innerHTML = `<p>${msg.loading}</p>`;
      
      try {
        await loadHelpIndex();
        
        if (helpIndex.length === 0) {
          resultsDiv.innerHTML = `<p>${msg.index_empty}</p>`;
          if (query) {
            resultsDiv.innerHTML += `<p>${msg.no_results_for(escapeHTML(query))}</p>`;
          }
          return;
        }
        
        if (query) {
          const results = search(query);
          
          if (results.length === 0) {
            resultsDiv.innerHTML = `<p>${msg.no_results_for(query)}</p>`;
          } else {
            let html = `<p>${msg.found_results(results.length, query)}</p>`;
            
            results.forEach(result => {
              const href = appendLangToUrl(result.url || result.path || './homepage.html');
              const safeTitle = escapeHTML(result.title || '');
              const safeSnippet = result.snippet || '';
              const safePath = escapeHTML(result.path || '');
               html += `
                 <div class="result-item">
                   <h3><a href="${href}" target="contentFrame">${safeTitle}</a></h3>
                   <p>${safeSnippet}</p>
                   <small>${safePath}</small>
                 </div>
               `;
            });
            
            resultsDiv.innerHTML = html;
          }
        } else {
          resultsDiv.innerHTML = `<p>${msg.no_query}</p>`;
          
          const topResults = helpIndex.slice(0, 5); // First 5 entries
          if (topResults.length > 0) {
            let html = `<p>${msg.popular_topics}</p>`;
            topResults.forEach(result => {
              const href = appendLangToUrl(result.url || result.path || './homepage.html');
              const safeTitle = escapeHTML(result.title || '');
               html += `
                 <div class="result-item">
                   <h3><a href="${href}" target="contentFrame">${safeTitle}</a></h3>
                 </div>
               `;
             });
            resultsDiv.innerHTML += html;
          }
        }
      } catch (error) {
        resultsDiv.innerHTML = `<p>Error loading search index: ${escapeHTML(error && error.message ? error.message : error)}</p>`;
      }
    }
    
    processSearch();
  </script>
</body>
</html>