<!--
//=============================================================================
// Copyright (c) 2016-present Allan CORNET (Nelson)
//=============================================================================
// This file is part of Nelson.
//=============================================================================
// LICENCE_BLOCK_BEGIN
// SPDX-License-Identifier: LGPL-3.0-or-later
// LICENCE_BLOCK_END
//=============================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Search Results</title>
  <link rel="stylesheet" href="nelson_common.css">
</head>
<body class="search-results-body">
  <!-- Help Summary Button at top right -->
  <a href="./homepage.html" class="home-summary-link">
    <button class="home-summary-btn" aria-label="Back to help homepage">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12L12 3l9 9"/>
        <path d="M9 21V12h6v9"/>
        <path d="M9 21h6"/>
      </svg>
    </button>
  </a>
  
  <h1 class="search-results-title">Search Results</h1>
  <div id="results" class="search-results-panel">
  </div>
  <script src="index.js"></script>
  
  <script>
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    
    let helpIndex = window.searchIndex || [];
    
    function search(query) {
      if (!query) return [];

      query = query.toLowerCase();

      let results = helpIndex.filter(item => {
        return item.title.toLowerCase().includes(query) ||
               item.content.toLowerCase().includes(query);
      }).map(item => {
        let snippet = item.content;
        const contentLower = item.content.toLowerCase();
        const queryIndex = contentLower.indexOf(query);

        if (queryIndex !== -1) {
          const start = Math.max(0, queryIndex - 40);
          const end = Math.min(item.content.length, queryIndex + query.length + 40);
          snippet = (start > 0 ? '...' : '') +
                    item.content.substring(start, end) +
                    (end < item.content.length ? '...' : '');
          const highlightedSnippet = snippet.replace(
            new RegExp(query, 'gi'),
            match => `<strong>${match}</strong>`
          );
          snippet = highlightedSnippet;
        } else {
          snippet = item.content.substring(0, 100) + (item.content.length > 100 ? '...' : '');
        }

        return {
          title: item.title,
          url: item.url,
          path: item.path,
          snippet: snippet
        };
      });

      // Move exact match to the front if present
      const exactIndex = results.findIndex(r => r.title.toLowerCase() === query);
      if (exactIndex > -1) {
        const [exactResult] = results.splice(exactIndex, 1);
        results.unshift(exactResult);
      }

      return results;
    }
    
    function loadHelpIndex() {
      return new Promise((resolve, reject) => {
        if (window.searchIndex && window.searchIndex.length > 0) {
          helpIndex = window.searchIndex;
          return resolve(helpIndex);
        }
      });
    }
    
    async function processSearch() {
      const query = getQueryParam('query');
      const resultsDiv = document.getElementById('results');
      
      resultsDiv.innerHTML = '<p>Loading search index...</p>';
      
      try {
        await loadHelpIndex();
        
        if (helpIndex.length === 0) {
          resultsDiv.innerHTML = '<p>Warning: Search index is empty or could not be loaded.</p>';
          if (query) {
            resultsDiv.innerHTML += `<p>Cannot perform search for: <strong>${query}</strong></p>`;
          }
          return;
        }
        
        if (query) {
          const results = search(query);
          
          if (results.length === 0) {
            resultsDiv.innerHTML = `<p>No results found for <strong>${query}</strong>.</p>`;
          } else {
            let html = `<p>Found ${results.length} results for <strong>${query}</strong>:</p>`;
            
            results.forEach(result => {
              html += `
                <div class="result-item">
                  <h3><a href="${result.url}" target="contentFrame">${result.title}</a></h3>
                  <p>${result.snippet}</p>
                  <small>${result.path}</small>
                </div>
              `;
            });
            
            resultsDiv.innerHTML = html;
          }
        } else {
          resultsDiv.innerHTML = '<p>No search term provided.</p>';
          
          const topResults = helpIndex.slice(0, 5); // First 5 entries
          if (topResults.length > 0) {
            let html = '<p>Popular topics:</p>';
            topResults.forEach(result => {
              html += `
                <div class="result-item">
                  <h3><a href="${result.url}" target="contentFrame">${result.title}</a></h3>
                </div>
              `;
            });
            resultsDiv.innerHTML += html;
          }
        }
      } catch (error) {
        resultsDiv.innerHTML = `<p>Error loading search index: ${error.message}</p>`;
      }
    }
    
    processSearch();
  </script>
</body>
</html>