version: 2.1
jobs:
  build:
    working_directory: ~/
    docker:
      - image: archlinux:latest
    environment:
      DISPLAY: ""
      OMP_NUM_THREADS: 4
      OMPI_ALLOW_RUN_AS_ROOT: 1
      OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1
    steps:
      - run: pacman -Sy --noconfirm
      - run: pacman -S base-devel --noconfirm
      - run: pacman -S git --noconfirm       
      - run: pacman -S gcc binutils glibc --noconfirm
      - run: pacman -S inetutils --noconfirm
      - run: pacman -S gawk --noconfirm
      - run: pacman -S m4 --noconfirm
      - run: pacman -S pkg-config --noconfirm
      - run: pacman -S boost-libs boost --noconfirm
      - run: pacman -S cmake --noconfirm
      - run: pacman -S libffi --noconfirm
      - run: pacman -S icu --noconfirm
      - run: pacman -S qt5-base --noconfirm
      - run: pacman -S qt5-tools --noconfirm
      - run: pacman -S qt5-webkit --noconfirm
      - run: pacman -S libxml2 --noconfirm
      - run: pacman -S gcc --noconfirm
      - run: pacman -S make --noconfirm
      - run: pacman -S blas --noconfirm
      - run: pacman -S lapack --noconfirm
      - run: pacman -S lapacke --noconfirm
      - run: pacman -S fftw --noconfirm
      - run: pacman -S openmpi --noconfirm
      - run: pacman -S hdf5 --noconfirm
      - run: pacman -S taglib --noconfirm
      - run: pacman -S portaudio --noconfirm
      - run: pacman -S libsndfile --noconfirm
      - run: pacman -S zlib --noconfirm
      - run: pacman -S curl --noconfirm
      - run: pacman -S libgit2 --noconfirm
      - run: echo -e "\n[arch4edu]\nServer =  https://mirrors.tuna.tsinghua.edu.cn/arch4edu/x86_64" | sudo tee -a /etc/pacman.conf 
      - run: pacman-key --refresh-keys     
      - run: pacman -Sy --noconfirm      
      - run: pacman -S libmatio --noconfirm
      - run: git clone https://gitlab.com/libeigen/eigen.git /tmp/eigen
      - run: mkdir /tmp/eigen-build && cd /tmp/eigen && git checkout 3.4 && cd - && cd /tmp/eigen-build && cmake . /tmp/eigen && make -j4 && make install;
      - run: git clone https://github.com/Nelson-numerical-software/nelson.git
      - run:
          command: git checkout ${CIRCLE_BRANCH}
          working_directory: ~/nelson
      - run:
          command: cmake -G "Unix Makefiles" .
          working_directory: ~/nelson
      - run:
          command: make -j8
          working_directory: ~/nelson
      - run:
          command: make get_module_skeleton
          working_directory: ~/nelson
      - run:
          command: make buildhelp
          working_directory: ~/nelson
      - run:
          command: make tests_minimal
          working_directory: ~/nelson
      - run:
          command: make package
          working_directory: ~/nelson
      - run: rm -rf ~/.gitconfig 2> /dev/null
      - run: rm -rf /etc/gitconfig 2> /dev/null
      - run:
          command: make tests_all_no_display
          working_directory: ~/nelson
